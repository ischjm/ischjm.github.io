---
title: SSM
date: 2022-02-21 00:00:00
permalink: /dev/java/core/ssm
author:
 name: p0jo
 link: https://wiki.pwddd.com
categories:
  - 开发
  - 后端
  - 微服务核心
tags:
  - SSM
  - Mabatis
  - Spring
  - SpringMVC
---

# SSM

## 环境搭建

### 引入依赖

引入Maven相关依赖

```xml
<dependencies>
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.11</version>
        <scope>test</scope>
    </dependency>

    <!--引入项目依赖的jar包 -->
    <!-- SpringMVC、Spring -->

    <!--引入pageHelper分页插件 -->
    <dependency>
        <groupId>com.github.pagehelper</groupId>
        <artifactId>pagehelper</artifactId>
        <version>5.0.0</version>
    </dependency>

    <!-- MBG -->
    <dependency>
        <groupId>org.mybatis.generator</groupId>
        <artifactId>mybatis-generator-core</artifactId>
        <version>1.3.5</version>
    </dependency>


    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-webmvc</artifactId>
        <version>4.3.7.RELEASE</version>
    </dependency>

    <!-- 返回json字符串的支持 -->
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.8.8</version>
    </dependency>

    <!--JSR303数据校验支持；tomcat7及以上的服务器，
    tomcat7以下的服务器：el表达式。额外给服务器的lib包中替换新的标准的el
    -->
    <dependency>
        <groupId>org.hibernate</groupId>
        <artifactId>hibernate-validator</artifactId>
        <version>5.4.1.Final</version>
    </dependency>


    <!-- Spring-Jdbc -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-jdbc</artifactId>
        <version>4.3.7.RELEASE</version>
    </dependency>

    <!--Spring-test -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-test</artifactId>
        <version>4.3.7.RELEASE</version>
    </dependency>


    <!-- Spring面向切面编程 -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-aspects</artifactId>
        <version>4.3.7.RELEASE</version>
    </dependency>

    <!--MyBatis -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis</artifactId>
        <version>3.4.2</version>
    </dependency>

    <!-- MyBatis整合Spring的适配包 -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis-spring</artifactId>
        <version>1.3.1</version>
    </dependency>

    <!-- 数据库连接池、驱动 -->
    <dependency>
        <groupId>c3p0</groupId>
        <artifactId>c3p0</artifactId>
        <version>0.9.1</version>
    </dependency>

    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>5.1.41</version>
    </dependency>

    <!-- （jstl，servlet-api，junit） -->
    <dependency>
        <groupId>jstl</groupId>
        <artifactId>jstl</artifactId>
        <version>1.2</version>
    </dependency>

    <dependency>
        <groupId>javax.servlet</groupId>
        <artifactId>javax.servlet-api</artifactId>
        <version>3.0.1</version>
        <scope>provided</scope>
    </dependency>

</dependencies>
```

### 引入前端资源

```jsp
<script type="text/javascript"
	src="${APP_PATH }/static/js/jquery-1.12.4.min.js"></script>
<link
	href="${APP_PATH }/static/bootstrap-3.3.7-dist/css/bootstrap.min.css"
	rel="stylesheet">
<script
	src="${APP_PATH }/static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
```

### 配置web.xml

```xml
<!DOCTYPE web-app PUBLIC
 "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
 "http://java.sun.com/dtd/web-app_2_3.dtd" >

<web-app>
    <!-- spring配置文件 加载 -->
    <context-param>
        <param-name>contextConfigLocation</param-name>
        <param-value>classpath:applicationContext.xml</param-value>
    </context-param>

    <!-- 编码拦截器 -->
    <filter>
        <filter-name>encodingFilter</filter-name>
        <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
        <init-param>
            <param-name>encoding</param-name>
            <param-value>utf-8</param-value>
        </init-param>
        <init-param>
            <param-name>forceRequestEncoding</param-name>
            <param-value>true</param-value>
        </init-param>
        <init-param>
            <param-name>forceResponseEncoding</param-name>
            <param-value>true</param-value>
        </init-param>
    </filter>

    <!-- rest风格拦截器 -->
    <filter>
        <filter-name>hiddenHttpMethodFilter</filter-name>
        <filter-class>org.springframework.web.filter.HiddenHttpMethodFilter</filter-class>
    </filter>

    <filter-mapping>
        <filter-name>encodingFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

    <filter-mapping>
        <filter-name>hiddenHttpMethodFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

    <!-- 加载Ioc容器 -->
    <listener>
        <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
    </listener>

    <!-- 配置mvc拦截器 -->
    <servlet>
        <servlet-name>dispatcherServlet</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <init-param>
            <param-name>contextConfigLocation</param-name>
            <param-value>classpath:spring-mvc.xml</param-value>
        </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>

    <servlet-mapping>
        <servlet-name>dispatcherServlet</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>
</web-app>
```

配置SpringMVC配置文件

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd">

    <!-- 不适用默认拦截器，配置只拦截COntroller包 -->
    <context:component-scan base-package="com.pwddd.ssm" use-default-filters="false">
        <context:include-filter type="annotation" expression="org.springframework.stereotype.Controller"/>
    </context:component-scan>

    <bean class="org.springframework.web.servlet.view.InternalResourceViewResolver" id="viewResolver">
        <property name="prefix" value="/WEB-INF/views/" />
        <property name="suffix" value=".jsp" />
    </bean>

    <!--  SpirngMvc处理不了的 交给tomcat   -->
    <mvc:default-servlet-handler default-servlet-name="default"/>
    <mvc:annotation-driven />
</beans>
```

配置数据库连接信息

```properties
jdbc.driver=com.mysql.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/ssm_crud
jdbc.username=root
jdbc.password=123456
```

配置spring配置文件

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">

    <context:component-scan base-package="com.pwddd.ssm">
        <context:exclude-filter type="annotation" expression="org.springframework.stereotype.Controller"/>
    </context:component-scan>

    <context:property-placeholder location="classpath:jdbc.properties" />
    <bean class="com.mchange.v2.c3p0.ComboPooledDataSource" id="dataSource">
        <property name="driverClass" value="${jdbc.driver}" />
        <property name="jdbcUrl" value="${jdbc.url}" />
        <property name="user" value="${jdbc.username}" />
        <property name="password" value="${jdbc.password}" />
    </bean>

    <bean class="org.springframework.jdbc.datasource.DataSourceTransactionManager" id="dataSourceTransactionManager">
        <property name="dataSource" ref="dataSource" />
    </bean>

    <!--  mybatis整合  -->
    <bean class="org.mybatis.spring.SqlSessionFactoryBean" id="sqlSessionFactory" >
        <property name="dataSource" ref="dataSource" />
        <property name="configLocation" value="classpath:mybatis-config.xml" />
        <property name="mapperLocations" value="classpath:mapper/*.xml" />
    </bean>

    <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer" >
        <property name="basePackage" value="com.pwddd.ssm.dao" />
    </bean>

    <!--  事务相关的配置  -->
    <aop:config>
        <aop:pointcut id="txPoint" expression="execution(* com.pwddd.service..*(..))" />
        <aop:advisor advice-ref="txAdvice" pointcut-ref="txPoint" />
    </aop:config>

    <tx:advice id="txAdvice" transaction-manager="dataSourceTransactionManager">
        <tx:attributes>
            <tx:method name="*"/>
            <tx:method name="get*" read-only="true" />
        </tx:attributes>
    </tx:advice>
</beans>
```

### 配置Mybatis配置文件

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <settings>
        <setting name="mapUnderscoreToCamelCase" value="true"/>
    </settings>

    <typeAliases>
        <package name="com.pwddd.ssm.bean"/>
    </typeAliases>

</configuration>
```

### 创建数据库表

```sql
/*
 Navicat Premium Data Transfer

 Source Server         : localhost
 Source Server Type    : MySQL
 Source Server Version : 50728
 Source Host           : localhost:3306
 Source Schema         : ssm_crud

 Target Server Type    : MySQL
 Target Server Version : 50728
 File Encoding         : 65001

 Date: 24/02/2022 14:48:02
*/

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for tbl_dept
-- ----------------------------
DROP TABLE IF EXISTS `tbl_dept`;
CREATE TABLE `tbl_dept`  (
  `dept_id` int(11) NOT NULL AUTO_INCREMENT,
  `dept_name` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  PRIMARY KEY (`dept_id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;

-- ----------------------------
-- Table structure for tbl_employee
-- ----------------------------
DROP TABLE IF EXISTS `tbl_employee`;
CREATE TABLE `tbl_employee`  (
  `emp_id` int(11) NOT NULL AUTO_INCREMENT,
  `emp_name` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `gender` char(1) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `email` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `d_id` int(11) NOT NULL,
  PRIMARY KEY (`emp_id`) USING BTREE,
  INDEX `fk_dept`(`d_id`) USING BTREE,
  CONSTRAINT `fk_dept` FOREIGN KEY (`d_id`) REFERENCES `tbl_dept` (`dept_id`) ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;

SET FOREIGN_KEY_CHECKS = 1;

```

### Mybatis逆向工程

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE generatorConfiguration
        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">
<generatorConfiguration>

    <context id="mybatismysql" targetRuntime="MyBatis3">
        <commentGenerator>
            <property name="suppressAllComments" value="true" />
        </commentGenerator>
        <!-- 配置数据库连接 -->
        <jdbcConnection driverClass="com.mysql.jdbc.Driver"
                        connectionURL="jdbc:mysql://localhost:3306/ssm_crud?useSSL=false"
                        userId="root"
                        password="123456">
        </jdbcConnection>

        <javaTypeResolver>
            <property name="forceBigDecimals" value="false" />
        </javaTypeResolver>

        <!-- 指定javaBean生成的位置 -->
        <javaModelGenerator targetPackage="com.pwddd.ssm.bean"
                            targetProject=".\src\main\java">
            <property name="enableSubPackages" value="true" />
            <property name="trimStrings" value="true" />
        </javaModelGenerator>

        <!--指定sql映射文件生成的位置 -->
        <sqlMapGenerator targetPackage="mapper" targetProject=".\src\main\resources">
            <property name="enableSubPackages" value="true" />
        </sqlMapGenerator>

        <!-- 指定dao接口生成的位置，mapper接口 -->
        <javaClientGenerator type="XMLMAPPER"
                             targetPackage="com.pwddd.ssm.dao" targetProject=".\src\main\java">
            <property name="enableSubPackages" value="true" />
        </javaClientGenerator>


        <!-- table指定每个表的生成策略 -->
        <table tableName="tbl_emp" domainObjectName="Employee"></table>
        <table tableName="tbl_dept" domainObjectName="Department"></table>
    </context>
</generatorConfiguration>
```

启动逆向工程

```java
public static void main(String[] args) throws Exception {
    List<String> warnings = new ArrayList<String>();
    boolean overwrite = true;
    File configFile = new File("mbg.xml");
    ConfigurationParser cp = new ConfigurationParser(warnings);
    Configuration config = cp.parseConfiguration(configFile);
    DefaultShellCallback callback = new DefaultShellCallback(overwrite);
    MyBatisGenerator myBatisGenerator = new MyBatisGenerator(config, callback, warnings);
    myBatisGenerator.generate(null);
}
```

### 修改生成的Mapper

```xml
  <select id="selectByPrimaryKeyWithDept" resultMap="WithDeptResultMap">
      select
      <if test="distinct">
        distinct
      </if>
      <include refid="WithDept_Column_List" />
      from tbl_employee e left join tbl_dept d on e.d_id = d.dept_id
      <if test="_parameter != null">
        <include refid="Example_Where_Clause" />
      </if>
      <if test="orderByClause != null">
        order by ${orderByClause}
      </if>
  </select>

  <select id="selectByExampleWithDept" resultMap="WithDeptResultMap">
    select
    <include refid="WithDept_Column_List" />
    from tbl_employee e left join tbl_dept d on e.d_id = d.dept_id
    where emp_id = #{empId,jdbcType=INTEGER}

  </select>

  <!--自定义联合查询-->
  <sql id="WithDept_Column_List">
    e.emp_id, e.emp_name, e.gender, e.email, e.dept_id , d.dept_name
  </sql>

  <resultMap id="WithDeptResultMap" type="com.pwddd.ssm.bean.Employee">
    <id column="emp_id" jdbcType="INTEGER" property="empId" />
    <result column="emp_name" jdbcType="VARCHAR" property="empName" />
    <result column="gender" jdbcType="CHAR" property="gender" />
    <result column="email" jdbcType="VARCHAR" property="email" />
    <association property="department" javaType="com.pwddd.ssm.bean.Department">
      <result column="dept_id" property="deptId" />
      <result column="dept_name" property="deptName" />
    </association>
  </resultMap> 
```

### Spring注入 测试Dao层

为了批量插入数据库，需要配置一个批量操作的SQLsession

```xml
<bean class="org.mybatis.spring.SqlSessionTemplate" id="sqlSession">
    <constructor-arg index="0" ref="sqlSessionFactory" />
    <constructor-arg index="1" value="BATCH" />
</bean>
```

批量插入数据

```java
    @Test
    public void testEmp(){
        EmployeeMapper mapper = sqlSession.getMapper(EmployeeMapper.class);

        for (int i = 0 ; i<=10000;i++){
            mapper.insertSelective(new Employee(
                UUID.randomUUID().toString().substring(0,5),
                "M",
                UUID.randomUUID().toString().substring(0,5)+"@qq.com",
                1));
        }
    }
```



## 数据处理

### 查询员工列表

1. 编写Controller，接收请求

```java
@GetMapping("/emps")
public String getEmps(@RequestParam(value = "pn",defaultValue = "1")Integer pn,
                      @RequestParam(value = "num",defaultValue = "5")Integer num,
                      Model model){
    // 设置分页
    PageHelper.startPage(pn,num);
    List<Employee> employees = employeeService.getEmps();
    PageInfo pageInfo = new PageInfo(employees,5);
    model.addAttribute("pageInfo",pageInfo);
    return "list";
}
```

2. 配置分页插件

```xml
<plugins>
    <plugin interceptor="com.github.pagehelper.PageInterceptor" />
</plugins>
```

3. 测试查询

```java
import com.github.pagehelper.PageInfo;
import com.pwddd.ssm.bean.Employee;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.mock.web.MockHttpServletRequest;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.web.WebAppConfiguration;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.MockMvcBuilder;
import org.springframework.test.web.servlet.MvcResult;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;
import org.springframework.web.context.WebApplicationContext;

import java.util.List;

@WebAppConfiguration
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = {"classpath:applicationContext.xml","classpath:spring-mvc.xml"})
public class TestMVC {

    @Autowired
    private WebApplicationContext applicationContext;

    private MockMvc mockMvc;

    @Before
    public void init(){
        mockMvc = MockMvcBuilders.webAppContextSetup(applicationContext).build();
    }

    @Test
    public void testSelectAllEmps() throws Exception {
        MvcResult mvcResult = mockMvc.perform(MockMvcRequestBuilders.get("/emps")
                .param("pn", "1").param("num", "20")).andReturn();
        MockHttpServletRequest request = mvcResult.getRequest();
        PageInfo pageInfo = (PageInfo) request.getAttribute("pageInfo");
        System.out.println(pageInfo);
        List<Employee> list = pageInfo.getList();
        for (Employee employee :
        list) {
            System.out.println(employee.getEmpId());
        }
    }
}

```

4. 编写页面,Index.jsp设置跳转我们的请求地址。

```jsp

<%@ page language="java" contentType="text/html; charset=UTF-8"
         pageEncoding="UTF-8"%>
<%@taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>员工列表</title>
<%
    pageContext.setAttribute("APP_PATH", request.getContextPath());
%>
    <!-- web路径：
不以/开始的相对路径，找资源，以当前资源的路径为基准，经常容易出问题。
以/开始的相对路径，找资源，以服务器的路径为标准(http://localhost:3306)；需要加上项目名
		http://localhost:3306/crud
 -->
    <script type="text/javascript"
            src="${APP_PATH}/static/js/jquery-1.12.4.min.js"></script>
    <link
            href="${APP_PATH}/static/bootstrap-3.3.7-dist/css/bootstrap.min.css"
            rel="stylesheet">
    <script
            src="${APP_PATH}/static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
</head>
<body>
<!-- 搭建显示页面 -->
<div class="container">
    <!-- 标题 -->
    <div class="row">
        <div class="col-md-12">
            <h1>SSM-CRUD</h1>
        </div>
    </div>
    <!-- 按钮 -->
    <div class="row">
        <div class="col-md-4 col-md-offset-8">
            <button class="btn btn-primary">新增</button>
            <button class="btn btn-danger">删除</button>
        </div>
    </div>
    <!-- 显示表格数据 -->
    <div class="row">
        <div class="col-md-12">
            <table class="table table-hover">
                <tr>
                    <th>#</th>
                    <th>empName</th>
                    <th>gender</th>
                    <th>email</th>
                    <th>deptName</th>
                    <th>操作</th>
                </tr>
                <c:forEach items="${pageInfo.list }" var="emp">
                    <tr>
                        <th>${emp.empId }</th>
                        <th>${emp.empName }</th>
                        <th>${emp.gender=="M"?"男":"女" }</th>
                        <th>${emp.email }</th>
                        <th>${emp.department.deptName }</th>
                        <th>
                            <button class="btn btn-primary btn-sm">
                                <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                编辑
                            </button>
                            <button class="btn btn-danger btn-sm">
                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                删除
                            </button>
                        </th>
                    </tr>
                </c:forEach>
            </table>
        </div>
    </div>

    <!-- 显示分页信息 -->
    <div class="row">
        <!--分页文字信息  -->
        <div class="col-md-6">当前 ${pageInfo.pageNum }页,总${pageInfo.pages }
            页,总 ${pageInfo.total } 条记录</div>
        <!-- 分页条信息 -->
        <div class="col-md-6">
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    <li><a href="${APP_PATH }/emps?pn=1">首页</a></li>
                    <c:if test="${pageInfo.hasPreviousPage }">
                        <li><a href="${APP_PATH }/emps?pn=${pageInfo.pageNum-1}"
                               aria-label="Previous"> <span aria-hidden="true">&laquo;</span>
                        </a></li>
                    </c:if>


                    <c:forEach items="${pageInfo.navigatepageNums }" var="page_Num">
                        <c:if test="${page_Num == pageInfo.pageNum }">
                            <li class="active"><a href="#">${page_Num }</a></li>
                        </c:if>
                        <c:if test="${page_Num != pageInfo.pageNum }">
                            <li><a href="${APP_PATH }/emps?pn=${page_Num }">${page_Num }</a></li>
                        </c:if>

                    </c:forEach>
                    <c:if test="${pageInfo.hasNextPage }">
                        <li><a href="${APP_PATH }/emps?pn=${pageInfo.pageNum+1 }"
                               aria-label="Next"> <span aria-hidden="true">&raquo;</span>
                        </a></li>
                    </c:if>
                    <li><a href="${APP_PATH }/emps?pn=${pageInfo.pages}">末页</a></li>
                </ul>
            </nav>
        </div>
    </div>

</div>
</body>
</html>

```

5. 注意：idea自动生成的web-app版本为2.3，该版本的web-app并不支持EL表达式，因此我们编写的jsp页面会出错。需要将web.xml的文档约束修改为如下的内容：

```xml
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee
         http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
         version="3.1">
```

#### 使用Ajax请求

```javascript
//1、页面加载完成以后，直接去发送ajax请求,要到分页数据
$(function(){
    //去首页
    to_page(1);
});
function to_page(pn){
    $.ajax({
        url:"${APP_PATH}/emps",
        data:"pn="+pn,
        type:"GET",
        success:function(result){
            //console.log(result);
            //1、解析并显示员工数据
            build_emps_table(result);
            //2、解析并显示分页信息
            build_page_info(result);
            //3、解析显示分页条数据
            build_page_nav(result);
        }
    });
}

function build_emps_table(result){
    //清空table表格
    $("#emps_table tbody").empty();
    var emps = result.extend.pageInfo.list;
    $.each(emps,function(index,item){
        var checkBoxTd = $("<td><input type='checkbox' class='check_item'/></td>");
        var empIdTd = $("<td></td>").append(item.empId);
        var empNameTd = $("<td></td>").append(item.empName);
        var genderTd = $("<td></td>").append(item.gender=='M'?"男":"女");
        var emailTd = $("<td></td>").append(item.email);
        var deptNameTd = $("<td></td>").append(item.department.deptName);
        /**
             <button class="">
             <span class="" aria-hidden="true"></span>
             编辑
             </button>
             */
        var editBtn = $("<button></button>").addClass("btn btn-primary btn-sm edit_btn")
        .append($("<span></span>").addClass("glyphicon glyphicon-pencil")).append("编辑");
        //为编辑按钮添加一个自定义的属性，来表示当前员工id
        editBtn.attr("edit-id",item.empId);
        var delBtn =  $("<button></button>").addClass("btn btn-danger btn-sm delete_btn")
        .append($("<span></span>").addClass("glyphicon glyphicon-trash")).append("删除");
        //为删除按钮添加一个自定义的属性来表示当前删除的员工id
        delBtn.attr("del-id",item.empId);
        var btnTd = $("<td></td>").append(editBtn).append(" ").append(delBtn);
        //var delBtn =
        //append方法执行完成以后还是返回原来的元素
        $("<tr></tr>").append(checkBoxTd)
            .append(empIdTd)
            .append(empNameTd)
            .append(genderTd)
            .append(emailTd)
            .append(deptNameTd)
            .append(btnTd)
            .appendTo("#emps_table tbody");
    });
}
//解析显示分页信息
function build_page_info(result){
    $("#page_info_area").empty();
    $("#page_info_area").append("当前"+result.extend.pageInfo.pageNum+"页,总"+
                                result.extend.pageInfo.pages+"页,总"+
                                result.extend.pageInfo.total+"条记录");
    totalRecord = result.extend.pageInfo.total;
    currentPage = result.extend.pageInfo.pageNum;
}
//解析显示分页条，点击分页要能去下一页....
function build_page_nav(result){
    //page_nav_area
    $("#page_nav_area").empty();
    var ul = $("<ul></ul>").addClass("pagination");

    //构建元素
    var firstPageLi = $("<li></li>").append($("<a></a>").append("首页").attr("href","#"));
    var prePageLi = $("<li></li>").append($("<a></a>").append("&laquo;"));
    if(result.extend.pageInfo.hasPreviousPage == false){
        firstPageLi.addClass("disabled");
        prePageLi.addClass("disabled");
    }else{
        //为元素添加点击翻页的事件
        firstPageLi.click(function(){
            to_page(1);
        });
        prePageLi.click(function(){
            to_page(result.extend.pageInfo.pageNum -1);
        });
    }



    var nextPageLi = $("<li></li>").append($("<a></a>").append("&raquo;"));
    var lastPageLi = $("<li></li>").append($("<a></a>").append("末页").attr("href","#"));
    if(result.extend.pageInfo.hasNextPage == false){
        nextPageLi.addClass("disabled");
        lastPageLi.addClass("disabled");
    }else{
        nextPageLi.click(function(){
            to_page(result.extend.pageInfo.pageNum +1);
        });
        lastPageLi.click(function(){
            to_page(result.extend.pageInfo.pages);
        });
    }



    //添加首页和前一页 的提示
    ul.append(firstPageLi).append(prePageLi);
    //1,2，3遍历给ul中添加页码提示
    $.each(result.extend.pageInfo.navigatepageNums,function(index,item){

        var numLi = $("<li></li>").append($("<a></a>").append(item));
        if(result.extend.pageInfo.pageNum == item){
            numLi.addClass("active");
        }
        numLi.click(function(){
            to_page(item);
        });
        ul.append(numLi);
    });
    //添加下一页和末页 的提示
    ul.append(nextPageLi).append(lastPageLi);

    //把ul加入到nav
    var navEle = $("<nav></nav>").append(ul);
    navEle.appendTo("#page_nav_area");
}
```

后台响应json数据，需要引入jackson，并设置@ResponseBody注解



### 添加页面显示部门下拉列表

1. 添加部门Controller

```java
@Controller
public class DeptController {

    @Autowired
    private DeptSerrvice deptSerrvice;

    @ResponseBody
    @RequestMapping("/depts")
    public Msg getAllDepts(){
        List<Department> depts  = deptSerrvice.getAllDepts();
        return Msg.success().add("depts",depts);
    }
}
```

2. 当用户点击编辑按钮时，发送Ajax请求，获取到部门信息

```js
//查出所有的部门信息并显示在下拉列表中
function getDepts(ele){
    //清空之前下拉列表的值
    $(ele).empty();
    $.ajax({
        url:"${APP_PATH}/depts",
        type:"GET",
        success:function(result){
            //{"code":100,"msg":"处理成功！",
            //"extend":{"depts":[{"deptId":1,"deptName":"开发部"},{"deptId":2,"deptName":"测试部"}]}}
            //console.log(result);
            //显示部门信息在下拉列表中
            //$("#empAddModal select").append("")
            $.each(result.extend.depts,function(){
                var optionEle = $("<option></option>").append(this.deptName).attr("value",this.deptId);
                optionEle.appendTo(ele);
            });
        }
    });

}
```



### 检测用户名是否可用

1. 编写对应的请求处理方法

```java
@GetMapping("/checkuser")
@ResponseBody
public Msg checkUser(@RequestParam("empName")String empName){
    boolean result = employeeService.checkUserName(empName);
    if (result){
        return Msg.success();
    }else {
        return Msg.fail().add("va_msg","用户名不可用！");
    }
}

public boolean checkUserName(String empName) {
    EmployeeExample employeeExample = new EmployeeExample();
    EmployeeExample.Criteria criteria = employeeExample.createCriteria();
    criteria.andEmpNameEqualTo(empName);
    long empsCount = employeeMapper.countByExample(employeeExample);
    if (empsCount == 0){
        return true;
    }else{
        return false;
    }
}
```

2. 前端发起Ajax请求

```js
//校验用户名是否可用
$("#empName_add_input").change(function(){
    //发送ajax请求校验用户名是否可用
    var empName = this.value;
    $.ajax({
        url:"${APP_PATH}/checkuser",
        data:"empName="+empName,
        type:"GET",
        success:function(result){
            if(result.code==100){
                show_validate_msg("#empName_add_input","success","用户名可用");
                $("#emp_save_btn").attr("ajax-va","success");
            }else{
                show_validate_msg("#empName_add_input","error",result.extend.va_msg);
                $("#emp_save_btn").attr("ajax-va","error");
            }
        }
    });
});
```



###  保存用户信息

1. 编写处理接受保存数据的方法

   ```java
   /**
        * 员工保存
        * 1、支持JSR303校验
        * 2、导入Hibernate-Validator
        *
        *
        * @return
        */
   @RequestMapping(value="/emp",method=RequestMethod.POST)
   @ResponseBody
   public Msg saveEmp(@Valid Employee employee, BindingResult result){
       if(result.hasErrors()){
           //校验失败，应该返回失败，在模态框中显示校验失败的错误信息
           Map<String, Object> map = new HashMap<>();
           List<FieldError> errors = result.getFieldErrors();
           for (FieldError fieldError : errors) {
               System.out.println("错误的字段名："+fieldError.getField());
               System.out.println("错误信息："+fieldError.getDefaultMessage());
               map.put(fieldError.getField(), fieldError.getDefaultMessage());
           }
           return Msg.fail().add("errorFields", map);
       }else{
           employeeService.addUser(employee);
           return Msg.success();
       }
   }
   ```

2. 设置后端JSR303校验

   ```java
   package com.pwddd.ssm.bean;
   
   import javax.validation.constraints.Pattern;
   
   
   
   public class Employee {
       private Integer empId;
   
       @Pattern(regexp="(^[a-zA-Z0-9_-]{6,16}$)|(^[\u2E80-\u9FFF]{2,5})"
                ,message="用户名必须是2-5位中文或者6-16位英文和数字的组合")
       private String empName;
   
       private String gender;
   
       //@Email
       @Pattern(regexp="^([a-z0-9_\\.-]+)@([\\da-z\\.-]+)\\.([a-z\\.]{2,6})$",
                message="邮箱格式不正确")
       private String email;
   
       private Integer dId;
   
       //希望查询员工的同时部门信息也是查询好的
       private Department department;
   
   
       public Employee(String empName, String gender, String email, Integer dId) {
           this.empName = empName;
           this.gender = gender;
           this.email = email;
           this.dId = dId;
       }
   
       @Override
       public String toString() {
           return "Employee [empId=" + empId + ", empName=" + empName
               + ", gender=" + gender + ", email=" + email + ", dId=" + dId
               + "]";
       }
   
       public Employee() {
           super();
       }
   
       public Employee(Integer empId, String empName, String gender, String email,
                       Integer dId) {
           super();
           this.empId = empId;
           this.empName = empName;
           this.gender = gender;
           this.email = email;
           this.dId = dId;
       }
   
       public Department getDepartment() {
           return department;
       }
   
       public void setDepartment(Department department) {
           this.department = department;
       }
   
       public Integer getEmpId() {
           return empId;
       }
   
       public void setEmpId(Integer empId) {
           this.empId = empId;
       }
   
       public String getEmpName() {
           return empName;
       }
   
       public void setEmpName(String empName) {
           this.empName = empName == null ? null : empName.trim();
       }
   
       public String getGender() {
           return gender;
       }
   
       public void setGender(String gender) {
           this.gender = gender == null ? null : gender.trim();
       }
   
       public String getEmail() {
           return email;
       }
   
       public void setEmail(String email) {
           this.email = email == null ? null : email.trim();
       }
   
       public Integer getdId() {
           return dId;
       }
   
       public void setdId(Integer dId) {
           this.dId = dId;
       }
   }
   
   ```

3. 前端Ajax将表单信息发送给服务器

   ```js
   //点击保存，保存员工。
   $("#emp_save_btn").click(function(){
       //1、模态框中填写的表单数据提交给服务器进行保存
       //1、先对要提交给服务器的数据进行校验
       if(!validate_add_form()){
           return false;
       };
       //1、判断之前的ajax用户名校验是否成功。如果成功。
       if($(this).attr("ajax-va")=="error"){
           return false;
       }
   
       //2、发送ajax请求保存员工
       $.ajax({
           url:"${APP_PATH}/emp",
           type:"POST",
           data:$("#empAddModal form").serialize(),
           success:function(result){
               //alert(result.msg);
               if(result.code == 100){
                   //员工保存成功；
                   //1、关闭模态框
                   $("#empAddModal").modal('hide');
   
                   //2、来到最后一页，显示刚才保存的数据
                   //发送ajax请求显示最后一页数据即可
                   to_page(totalRecord);
               }else{
                   //显示失败信息
                   //console.log(result);
                   //有哪个字段的错误信息就显示哪个字段的；
                   if(undefined != result.extend.errorFields.email){
                       //显示邮箱错误信息
                       show_validate_msg("#email_add_input", "error", result.extend.errorFields.email);
                   }
                   if(undefined != result.extend.errorFields.empName){
                       //显示员工名字的错误信息
                       show_validate_msg("#empName_add_input", "error", result.extend.errorFields.empName);
                   }
               }
           }
       });
   });
   
   //校验表单数据
   function validate_add_form(){
       //1、拿到要校验的数据，使用正则表达式
       var empName = $("#empName_add_input").val();
       var regName = /(^[a-zA-Z0-9_-]{6,16}$)|(^[\u2E80-\u9FFF]{2,5})/;
       if(!regName.test(empName)){
           //alert("用户名可以是2-5位中文或者6-16位英文和数字的组合");
           show_validate_msg("#empName_add_input", "error", "用户名可以是2-5位中文或者6-16位英文和数字的组合");
           return false;
       }else{
           show_validate_msg("#empName_add_input", "success", "");
       };
   
       //2、校验邮箱信息
       var email = $("#email_add_input").val();
       var regEmail = /^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/;
       if(!regEmail.test(email)){
           //alert("邮箱格式不正确");
           //应该清空这个元素之前的样式
           show_validate_msg("#email_add_input", "error", "邮箱格式不正确");
           /* $("#email_add_input").parent().addClass("has-error");
               $("#email_add_input").next("span").text("邮箱格式不正确"); */
           return false;
       }else{
           show_validate_msg("#email_add_input", "success", "");
       }
       return true;
   }
   
   //显示校验结果的提示信息
   function show_validate_msg(ele,status,msg){
       //清除当前元素的校验状态
       $(ele).parent().removeClass("has-success has-error");
       $(ele).next("span").text("");
       if("success"==status){
           $(ele).parent().addClass("has-success");
           $(ele).next("span").text(msg);
       }else if("error" == status){
           $(ele).parent().addClass("has-error");
           $(ele).next("span").text(msg);
       }
   }
   ```

4. 添加用户后需要跳转到最后一页，显示添加的数据。在分页时需要确保分页的插件显示的信息在合理的范围之内，需要对分页插件进行属性的配置。配置分页合理化参数。

   ```xml
   <plugins>
       <plugin interceptor="com.github.pagehelper.PageInterceptor" >
           <property name="reasonable" value="true"/>
       </plugin>
   </plugins>
   ```

### 更新员工信息

1. 前端发起Ajax请求

   ```js
   //点击更新，更新员工信息
   $("#emp_update_btn").click(function(){
       //验证邮箱是否合法
       //1、校验邮箱信息
       var email = $("#email_update_input").val();
       var regEmail = /^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/;
       if(!regEmail.test(email)){
           show_validate_msg("#email_update_input", "error", "邮箱格式不正确");
           return false;
       }else{
           show_validate_msg("#email_update_input", "success", "");
       }
   
       //2、发送ajax请求保存更新的员工数据
       $.ajax({
           url:"${APP_PATH}/emp/"+$(this).attr("edit-id"),
           type:"PUT",
           data:$("#empUpdateModal form").serialize(),
           success:function(result){
               //alert(result.msg);
               //1、关闭对话框
               $("#empUpdateModal").modal("hide");
               //2、回到本页面
               to_page(currentPage);
           }
       });
   });
   ```

2. 需要设置一个过滤器，用于将ajax请求中的数据封装到bean中

   ```xml
   
   <filter>
       <filter-name>httpPutFormContentFilter</filter-name>
       <filter-class>org.springframework.web.filter.HttpPutFormContentFilter</filter-class>
   </filter>
   
   <filter-mapping>
       <filter-name>httpPutFormContentFilter</filter-name>
       <url-pattern>/*</url-pattern>
   </filter-mapping>
   ```

3. 后台编写处理请求的相关方法

   ```java
   /**
        * 如果直接发送ajax=PUT形式的请求
        * 封装的数据
        * Employee
        * [empId=1014, empName=null, gender=null, email=null, dId=null]
        *
        * 问题：
        * 请求体中有数据；
        * 但是Employee对象封装不上；
        * update tbl_emp  where emp_id = 1014;
        *
        * 原因：
        * Tomcat：
        * 		1、将请求体中的数据，封装一个map。
        * 		2、request.getParameter("empName")就会从这个map中取值。
        * 		3、SpringMVC封装POJO对象的时候。
        * 				会把POJO中每个属性的值，request.getParamter("email");
        * AJAX发送PUT请求引发的血案：
        * 		PUT请求，请求体中的数据，request.getParameter("empName")拿不到
        * 		Tomcat一看是PUT不会封装请求体中的数据为map，只有POST形式的请求才封装请求体为map
        * org.apache.catalina.connector.Request--parseParameters() (3111);
        *
        * protected String parseBodyMethods = "POST";
        * if( !getConnector().isParseBodyMethod(getMethod()) ) {
        success = true;
        return;
        }
        *
        *
        * 解决方案；
        * 我们要能支持直接发送PUT之类的请求还要封装请求体中的数据
        * 1、配置上HttpPutFormContentFilter；
        * 2、他的作用；将请求体中的数据解析包装成一个map。
        * 3、request被重新包装，request.getParameter()被重写，就会从自己封装的map中取数据
        * 员工更新方法
        * @param employee
        * @return
        */
   @ResponseBody
   @RequestMapping(value="/emp/{empId}",method=RequestMethod.PUT)
   public Msg saveEmp(Employee employee, HttpServletRequest request){
       System.out.println("请求体中的值："+request.getParameter("gender"));
       System.out.println("将要更新的员工数据："+employee);
       employeeService.updateEmp(employee);
       return Msg.success()	;
   }
   
   /**
   	 * 员工更新
   	 * @param employee
   	 */
   public void updateEmp(Employee employee) {
       // TODO Auto-generated method stub
       employeeMapper.updateByPrimaryKeySelective(employee);
   }
   ```

### 删除员工信息

1. Ajax发起删除员工请求

   ```js
   //单个删除
   $(document).on("click",".delete_btn",function(){
       //1、弹出是否确认删除对话框
       var empName = $(this).parents("tr").find("td:eq(2)").text();
       var empId = $(this).attr("del-id");
       //alert($(this).parents("tr").find("td:eq(1)").text());
       if(confirm("确认删除【"+empName+"】吗？")){
           //确认，发送ajax请求删除即可
           $.ajax({
               url:"${APP_PATH}/emp/"+empId,
               type:"DELETE",
               success:function(result){
                   alert(result.msg);
                   //回到本页
                   to_page(currentPage);
               }
           });
       }
   });
   ```

2. 后端编写方法处理请求

   ```java
   /**
   	 * 单个批量二合一
   	 * 批量删除：1-2-3
   	 * 单个删除：1
   	 * 
   	 * @param id
   	 * @return
   	 */
   @ResponseBody
   @RequestMapping(value="/emp/{ids}",method=RequestMethod.DELETE)
   public Msg deleteEmp(@PathVariable("ids")String ids){
       //批量删除
       if(ids.contains("-")){
           List<Integer> del_ids = new ArrayList<>();
           String[] str_ids = ids.split("-");
           //组装id的集合
           for (String string : str_ids) {
               del_ids.add(Integer.parseInt(string));
           }
           employeeService.deleteBatch(del_ids);
       }else{
           Integer id = Integer.parseInt(ids);
           employeeService.deleteEmp(id);
       }
       return Msg.success();
   }
   
   /**
        * 员工删除
        * @param id
        */
   public void deleteEmp(Integer id) {
       // TODO Auto-generated method stub
       employeeMapper.deleteByPrimaryKey(id);
   }
   
   public void deleteBatch(List<Integer> ids) {
       // TODO Auto-generated method stub
       EmployeeExample example = new EmployeeExample();
       EmployeeExample.Criteria criteria = example.createCriteria();
       //delete from xxx where emp_id in(1,2,3)
       criteria.andEmpIdIn(ids);
       employeeMapper.deleteByExample(example);
   }
   ```

3. 设置批量删除员工Ajax请求

   ```js
   //完成全选/全不选功能
   $("#check_all").click(function(){
       //attr获取checked是undefined;
       //我们这些dom原生的属性；attr获取自定义属性的值；
       //prop修改和读取dom原生属性的值
       $(".check_item").prop("checked",$(this).prop("checked"));
   });
   
   //check_item
   $(document).on("click",".check_item",function(){
       //判断当前选择中的元素是否5个
       var flag = $(".check_item:checked").length==$(".check_item").length;
       $("#check_all").prop("checked",flag);
   });
   
   //点击全部删除，就批量删除
   $("#emp_delete_all_btn").click(function(){
       //
       var empNames = "";
       var del_idstr = "";
       $.each($(".check_item:checked"),function(){
           //this
           empNames += $(this).parents("tr").find("td:eq(2)").text()+",";
           //组装员工id字符串
           del_idstr += $(this).parents("tr").find("td:eq(1)").text()+"-";
       });
       //去除empNames多余的,
       empNames = empNames.substring(0, empNames.length-1);
       //去除删除的id多余的-
       del_idstr = del_idstr.substring(0, del_idstr.length-1);
       if(confirm("确认删除【"+empNames+"】吗？")){
           //发送ajax请求删除
           $.ajax({
               url:"${APP_PATH}/emp/"+del_idstr,
               type:"DELETE",
               success:function(result){
                   alert(result.msg);
                   //回到当前页面
                   to_page(currentPage);
               }
           });
       }
   });
   ```

## 总结

![image-20220225134927672](https://wiki-1251603812.cos.ap-shanghai.myqcloud.com/images/image-20220225134927672.png)
